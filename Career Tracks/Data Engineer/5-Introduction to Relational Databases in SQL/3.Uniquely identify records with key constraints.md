#  Enforce data consistency with attribute constraints

## Key and superkeys
What is a key?

* Attribute(s) that identify a record uniquely
* As long as attributes can be removed: superkey
* If no more attributes can be removed: minimal superkey or key


## Get to know SELECT COUNT DISTINCT


```
SELECT COUNT(DISTINCT(column_a, column_b, ...))
FROM table;
```

```
-- Count the number of distinct values in the university_city column
SELECT count(distinct(university_city)) 
FROM universities;
```

## Identify keys with SELECT COUNT DISTINCT

There's a very basic way of finding out what qualifies for a key in an existing, populated table:

* Count the distinct records for all possible combinations of columns. If the resulting number x equals the number of all rows in the table for a combination, you have discovered a superkey.

* Then remove one column after another until you can no longer remove columns without seeing the number x decrease. If that is the case, you have discovered a (candidate) key.

```
-- Try out different combinations
select COUNT(distinct(firstname,lastname)) 
FROM professors;
```

Indeed, the only combination that uniquely identifies professors is {firstname, lastname}.


## Primary keys

* One primary key per database table, chosen from candidate keys
* Uniquely identifies records, e.g. for referencing in other tables
* Unique and not-null constraints both apply
* Primary keys are time-invariant: choose columns wisely!

### Specifying primary keys


```
CREATE TABLE products (    
    product_no integer UNIQUE NOT NULL,   
    name text,    
    price numeric);

CREATE TABLE products (    
    product_no integer PRIMARY KEY,
    name text,
    price numeric);

CREATE TABLE example (    
    a integer,    
    b integer,    
    c integer,
    PRIMARY KEY (a, c));

ALTER TABLE table_name 
ADD CONSTRAINT some_name 
PRIMARY KEY (column_name)

```



## ADD key CONSTRAINTs to the tables


```
-- Rename the organization column to id
alter table organizations
rename column organization TO id;

-- Make id a primary key
ALTER TABLE organizations
add constraint organization_pk primary KEY (id);

```

```
-- Rename the university_shortname column to id
alter table universities
rename column university_shortname TO id;

-- Make id a primary key
ALTER TABLE universities
add constraint university_pk primary KEY (id);
```


## Surrogate keys
* Primary keys should be built from as few columns as possible
* Primary keys should never change over time

Adding a surrogate key with serial data type

```
ALTER TABLE cars
ADD COLUMN id serial PRIMARY KEY;INSERT INTO cars VALUES ('Volkswagen', 'Blitz', 'black');

```

### Another type of surrogate key

```
ALTER TABLE table_name
ADDCOLUMN column_c varchar(256);

UPDATE table_name SET column_c = CONCAT(column_a, column_b);

ALTER TABLE table_name 
ADD CONSTRAINT pk PRIMARY KEY (column_c);
```

## Add a SERIAL surrogate key


```
-- Add the new column to the table
ALTER TABLE professors 
add column id serial;

-- Make id a primary key
ALTER table professors 
add CONSTRAINT professors_pkey primary key (id);

-- Have a look at the first 10 rows of professors
select * from professors limit 10;
```


## CONCATenate columns to a surrogate key

Another strategy to add a surrogate key to an existing table is to concatenate existing columns with the CONCAT() function.

```
CREATE TABLE cars (
 make varchar(64) NOT NULL,
 model varchar(64) NOT NULL,
 mpg integer NOT NULL
)
```

The table is populated with 10 rows of completely fictional data.

Unfortunately, the table doesn't have a primary key yet. None of the columns consists of only unique values, so some columns can be combined to form a key.

```
-- Count the number of distinct rows with columns make, model
SELECT COUNT(DISTINCT(make, model)) 
FROM cars;

-- Add the id column
ALTER TABLE cars
ADD COLUMN id varchar(128);
```

Concatenate make and model into id using an 
UPDATE table_name SET column_name = ... query and the CONCAT() function.

```
-- Update id with make + model
UPDATE cars
set id = concat(make, model);
```

Make id a primary key and name it id_pk.

```
-- Make id a primary key
alter table cars
add constraint id_pk primary key(id);

-- Have a look at the table
SELECT * FROM cars;
```

## Test

Let's think of an entity type "student". A student has:

* a last name consisting of up to 128 characters (required),
* a unique social security number, consisting only of integers, that should serve as a key,
* a phone number of fixed length 12, consisting of numbers and characters (but some students don't have one).

```
-- Create the table
create table students (
  last_name varchar(128) not null,
  ssn integer primary key,
  phone_no char(12)
);
```